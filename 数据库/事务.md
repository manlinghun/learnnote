# 事务

## 概念

* **脏读：** 脏读是指某一个事务读取到了其他事务未提交的数据，如果此数据回滚，将导致读取到的数据是错误的数据。
* **不可重复读：** 指某个事务在开启后，读取某个范围或者某条数据时，在此事务未结束的时间里内，其他事务对表内的数据进行了添加，或者更改了某一条或者多条数据后进行了提交，此时本事务读取到的数据条数与之前某时间段读取到的条数不相同，或者在读取一条数据时，两个时间段内读取到的数据值不相同。
* **幻读：** 在一个事务开启后，其他事务对表中的一行或者多行进行了更改操作后进行了提交，本事务读取到的一行或多行的值仍和数量然是相同的，此时并不能读到其他事务在本事务查询时，提交的更改内容，即：其他事务对此表的更改本事务不能读到，这达成了可重复读的目的，但是读取到的数据是虚幻的。如果其他事物在此之间真实的更改了数据，则在本事务提交之前的读操作，读取到的都是未被更改前的数据，造成了读取的数据是虚幻的。

> 重复读可以解决不可重复读问题。不可重复读对应的是修改 UPDATE操作。但是可能会有幻读问题。因为幻读问题对应的是插入INSERT操作，而不是UPDATE操作。

## 事务四大特征

* 原子性：指事物包含的所有操作要么全部成功，要么全部回滚。
* 一致性：指事物必须是数据库从一个一致性状态到另一个一致性状态。也就是说一个事物执行之前和执行之后都必须处于一致性状态。
* 隔离性：当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事物之间要相互隔离。
* 持久性：指事务一旦被提交，那么数据库的数据的改变就是永久性的，即便是在数据库系统遇到故障的情况下也不会丢失事务的操作。


## 隔离级别

1. Read uncommitted(读未提交)
   如果一个事务已经开始写数据，则另外一个事务不允许同时进行写操作，但允许其他事务读此行数据，该隔离级别可以通过“排他写锁”，但是不排斥读线程实现。这样就避免了更新丢失，却可能出现脏读，也就是说事务B读取到了事务A未提交的数据
   **解决了更新丢失，但还是可能会出现脏读**

2. Read committed(读提交)
   如果是一个读事务(线程)，则允许其他事务读写，如果是写事务将会禁止其他事务访问该行数据，该隔离级别避免了脏读，但是可能出现不可重复读。事务A事先读取了数据，事务B紧接着更新了数据，并提交了事务，而事务A再次读取该数据时，数据已经发生了改变
   **解决了更新丢失和脏读问题**

3. Repeatable read(可重复读取)
   可重复读取是指在一个事务内，多次读同一个数据，在这个事务还没结束时，其他事务不能访问该数据(包括了读写)，这样就可以在同一个事务内两次读到的数据是一样的，因此称为是可重复读隔离级别，读取数据的事务将会禁止写事务(但允许读事务)，写事务则禁止任何其他事务(包括了读写)，这样避免了不可重复读和脏读，但是有时可能会出现幻读。(读取数据的事务)可以通过“共享读镜”和“排他写锁”实现
   **解决了更新丢失、脏读、不可重复读、但是还会出现幻读**

4. Serializable(可序化)
   提供严格的事务隔离，它要求事务序列化执行，事务只能一个接着一个地执行，但不能并发执行，如果仅仅通过“行级锁”是无法实现序列化的，必须通过其他机制保证新插入的数据不会被执行查询操作的事务访问到。序列化是最高的事务隔离级别，同时代价也是最高的，性能很低，一般很少使用，在该级别下，事务顺序执行，不仅可以避免脏读、不可重复读，还避免了幻读
   **解决了更新丢失、脏读、不可重复读、幻读(虚读)**
